"use client";

import React, { useState } from 'react';
import { UserPlus, Save, Loader2, Copy, Check } from 'lucide-react';

export default function CIFGenerationPage() {
    // Define the maximum allowed no_cif on the frontend
    const MAX_no_cif_FRONTEND = 10;

    const [formData, setFormData] = useState({
        region: 'O - UAT',
        no_cif: 1,
        accountType: 'PCIF'
    });
    const [loading, setLoading] = useState(false);
    const [generatedCifs, setGeneratedCifs] = useState([]);
    const [copied, setCopied] = useState(false);

    const regions = [
        'O - UAT', 'X - UAT', 'Y - UAT', 'Z - UAT',
        'K - Pre-Prod', 'J - Pre-Prod', 'R1 - Pre-Prod',
        'Y2 - Pre-Prod', 'L - Pre-Prod', 'C - Pre-Prod'
    ];

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setGeneratedCifs([]);

        try {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || !currentUser.token) {
                throw new Error("You must be logged in to generate CIFs.");
            }

            // Extract just the region letter (e.g., 'O', 'K') for the backend payload
            const regionCodeForBackend = formData.region.split(' ')[0];

            // Payload for backend, ensures no_cif is never more than 10
            const payload = {
                region: regionCodeForBackend,
                no_cif: Math.min(parseInt(formData.no_cif, 10), MAX_no_cif_FRONTEND),
                acc_type: formData.accountType
            };

            const response = await fetch('http://10.1.161.165:5050/create_cif/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentUser.token}`
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to generate CIFs');
            }

            const data = await response.json();
            // Backend returns array of objects with structure: {res_data: string, RRN: string}
            const cifs = Array.isArray(data) ? data : (data.cif_list || []);

            setGeneratedCifs(cifs);

            // Update Local Storage for Dashboard Stats
            const userKey = `userData_${currentUser.username}`;
            const userData = JSON.parse(localStorage.getItem(userKey) || '{"cifs": [], "accounts": []}');

            // Parse each CIF object to extract CUSTOMER_NUMBER from res_data
            const newCifEntries = cifs.map(cifItem => {
                try {
                    const parsedResData = JSON.parse(cifItem.res_data);
                    return {
                        id: Date.now() + Math.random(),
                        cifNumber: parsedResData.CUSTOMER_NUMBER || 'N/A',
                        rrn: cifItem.RRN || 'N/A',
                        firstName: 'Generated',
                        lastName: 'User',
                        region: formData.region,
                        createdAt: new Date().toISOString(),
                        type: 'CIF'
                    };
                } catch (e) {
                    console.error('Error parsing CIF res_data:', e);
                    return {
                        id: Date.now() + Math.random(),
                        cifNumber: 'Parse Error',
                        rrn: cifItem.RRN || 'N/A',
                        firstName: 'Generated',
                        lastName: 'User',
                        region: formData.region,
                        createdAt: new Date().toISOString(),
                        type: 'CIF'
                    };
                }
            });

            userData.cifs.push(...newCifEntries);
            localStorage.setItem(userKey, JSON.stringify(userData));

            alert(`Successfully generated ${cifs.length} CIFs!`);

        } catch (error) {
            console.error('Error generating CIF:', error);
            alert(error.message || 'Failed to generate CIFs');
        } finally {
            setLoading(false);
        }
    };

    const copyToClipboard = () => {
        // Extract CUSTOMER_NUMBER from each CIF for copying
        const cifNumbers = generatedCifs.map(cifItem => {
            try {
                const parsedResData = JSON.parse(cifItem.res_data);
                return parsedResData.CUSTOMER_NUMBER || 'N/A';
            } catch (e) {
                return 'Parse Error';
            }
        });
        navigator.clipboard.writeText(cifNumbers.join('\n'));
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };

    const primaryColor = '#1D4ED8';

    return (
        <div>
            <div style={{ marginBottom: '2rem' }}>
                <h1 style={{ fontSize: '1.875rem', fontWeight: '700', color: '#111827', display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                    <UserPlus size={32} color={primaryColor} />
                    CIF Generation
                </h1>
                <p style={{ color: '#6B7280', marginTop: '0.5rem' }}>Bulk generate Customer Information Files.</p>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem' }}>
                {/* Form Section */}
                <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '1rem', boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)', height: 'fit-content' }}>
                    <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>

                        <div className="form-group">
                            <label htmlFor="region" style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '500', color: '#374151' }}>Region</label>
                            <select
                                id="region"
                                required
                                style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #D1D5DB' }}
                                value={formData.region}
                                onChange={(e) => setFormData({ ...formData, region: e.target.value })}
                            >
                                {regions.map(r => (
                                    <option key={r} value={r}>{r}</option>
                                ))}
                            </select>
                        </div>

                        <div className="form-group">
                            <label htmlFor="no_cif" style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '500', color: '#374151' }}>Number of CIFs</label>
                            <input
                                type="number"
                                id="no_cif"
                                required
                                min="1"
                                max={MAX_no_cif_FRONTEND}
                                style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #D1D5DB' }}
                                value={formData.no_cif}
                                onChange={(e) => {
                                    const value = Math.min(e.target.value, MAX_no_cif_FRONTEND);
                                    setFormData({ ...formData, no_cif: value });
                                }}
                            />
                            <p style={{ marginTop: '0.5rem', fontSize: '0.875rem', color: '#6B7280' }}>Maximum {MAX_no_cif_FRONTEND} CIFs per request.</p>
                        </div>

                        <div className="form-group">
                            <label htmlFor="accountType" style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '500', color: '#374151' }}>Account Type</label>
                            <select
                                id="accountType"
                                required
                                style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #D1D5DB' }}
                                value={formData.accountType}
                                onChange={(e) => setFormData({ ...formData, accountType: e.target.value })}
                            >
                                <option value="PCIF">Personal CIF Creation</option>
                                <option value="NPCIF">Non-Personal CIF Creation</option>
                            </select>
                        </div>

                        <button
                            type="submit"
                            disabled={loading}
                            style={{
                                background: primaryColor,
                                color: 'white',
                                padding: '0.75rem 1rem',
                                borderRadius: '0.5rem',
                                border: 'none',
                                fontWeight: '600',
                                cursor: loading ? 'not-allowed' : 'pointer',
                                opacity: loading ? 0.6 : 1,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '0.5rem'
                            }}
                        >
                            {loading ? <Loader2 className="animate-spin" size={20} /> : <Save size={20} />}
                            {loading ? 'Generating...' : 'Generate CIFs'}
                        </button>
                    </form>
                </div>

                {/* Results Section */}
                <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '1rem', boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)' }}>
                    <h2 style={{ fontSize: '1.25rem', fontWeight: '600', color: '#111827', marginBottom: '1rem' }}>Generated CIFs</h2>
                    {generatedCifs.length > 0 ? (
                        <div>
                            <button
                                onClick={copyToClipboard}
                                style={{
                                    background: copied ? '#059669' : '#4B5563',
                                    color: 'white',
                                    padding: '0.5rem 1rem',
                                    borderRadius: '0.5rem',
                                    border: 'none',
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.5rem',
                                    marginBottom: '1rem'
                                }}
                            >
                                {copied ? <Check size={16} /> : <Copy size={16} />}
                                {copied ? 'Copied!' : 'Copy all CIFs'}
                            </button>
                            <ul style={{ listStyleType: 'none', padding: 0, maxHeight: '400px', overflowY: 'auto' }}>
                                {generatedCifs.map((cifItem, index) => {
                                    try {
                                        const parsedResData = JSON.parse(cifItem.res_data);
                                        return (
                                            <li key={index} style={{ padding: '0.5rem 0', borderBottom: '1px solid #E5E7EB', color: '#374151', fontFamily: 'monospace' }}>
                                                <p style={{ margin: 0 }}>Customer Number: {parsedResData.CUSTOMER_NUMBER}</p>
                                            </li>
                                        );
                                    } catch (e) {
                                        return (
                                            <li key={index} style={{ padding: '0.5rem 0', borderBottom: '1px solid #E5E7EB', color: '#EF4444', fontFamily: 'monospace' }}>
                                                <p style={{ margin: 0 }}>Error parsing res_data</p>
                                            </li>
                                        );
                                    }
                                })}
                            </ul>
                        </div>
                    ) : (
                        <p style={{ color: '#6B7280' }}>No CIFs generated yet. Fill out the form and submit.</p>
                    )}
                </div>
            </div>
        </div>
    );
}















What changed:
Fixed the response handling to parse {res_data, RRN} objects from backend
Updated the display logic to extract and show CUSTOMER_NUMBER from res_data
Modified the copy function to extract customer numbers properly
Added error handling for JSON parsing




