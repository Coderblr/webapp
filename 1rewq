'use client';

import React, { useState } from 'react';
import styles from './ErrorResolverView.module.css';

const ErrorResolverView = () => {
  const [searchCode, setSearchCode] = useState('');
  const [result, setResult] = useState(null);
  const [isSearched, setIsSearched] = useState(false);
  const [loading, setLoading] = useState(false);

  // âœ… Utility to format numbered text (no JSX/CSS change)
  const formatNumberedText = (items) =>
    items
      .filter(Boolean)
      .map((item, index) => `${index + 1}. ${item}`)
      .join('\n');

  const handleSearch = async (e) => {
    e.preventDefault();

    if (!searchCode.trim()) return;

    setIsSearched(true);
    setLoading(true);
    setResult(null);

    try {
      const response = await fetch(
        `http://localhost:8000/error?error_code=${searchCode.trim()}`
      );

      if (!response.ok) {
        if (response.status === 404) {
          setResult(null);
          return;
        }
        throw new Error('Server error');
      }

      const data = await response.json();

      // ðŸ”¥ Map backend response â†’ existing UI structure
      const mappedResult = {
        code: data.error_code,
        description: data.error_description,
        causes: formatNumberedText([data.cause1, data.cause2]),
        solution: formatNumberedText([data.action1, data.action2])
      };

      setResult(mappedResult);
    } catch (error) {
      console.error('Error fetching error details:', error);
      setResult(null);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className={styles.viewContainer}>
      <div className={styles.header}>
        <h1 className={styles.title}>
          Error <span style={{ color: '#3b82f6' }}>Resolver</span>
        </h1>
        <p className={styles.subtitle}>
          Locate solutions and causes for system errors instantly.
        </p>
      </div>

      <form onSubmit={handleSearch} className={styles.searchBox}>
        <input
          type="text"
          className={styles.input}
          placeholder="Type error code (e.g. ERR_500)..."
          value={searchCode}
          onChange={(e) => setSearchCode(e.target.value)}
        />
        <button
          type="submit"
          className={styles.searchButton}
          disabled={loading}
        >
          {loading ? 'Searching...' : 'Search'}
        </button>
      </form>

      {isSearched && (
        <div className={styles.resultArea}>
          {result ? (
            <div className={styles.resultCard}>
              <h2 className={styles.errorCode}>{result.code}</h2>

              <div className={styles.section}>
                <span className={styles.label}>Description</span>
                <p className={styles.value}>{result.description}</p>
              </div>

              <div className={styles.section}>
                <span className={styles.label}>What causes this?</span>
                <p
                  className={styles.value}
                  style={{ whiteSpace: 'pre-line' }}
                >
                  {result.causes}
                </p>
              </div>

              <div className={styles.section}>
                <span className={styles.label}>How to resolve?</span>
                <div className={styles.solutionBox}>
                  <p
                    className={styles.value}
                    style={{ whiteSpace: 'pre-line' }}
                  >
                    {result.solution}
                  </p>
                </div>
              </div>
            </div>
          ) : (
            <div className={styles.notFound}>
              <h3>Record Not Found</h3>
              <p>
                The error code "{searchCode}" was not found in our database.
              </p>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

export default ErrorResolverView;