//account
"use client";
import { useState, useEffect } from "react";
// Import useRouter to programmatically navigate if token is missing or invalid
import { useRouter } from 'next/navigation';
import styles from "./page.module.css";

export default function AccountCreationForm() {
  const [accountType, setAccountType] = useState('DEPOSIT');
  const [region, setRegion] = useState("O");
  const [cifNumber, setCifNumber] = useState("");
  const [productCode, setProductCode] = useState("");
  const [accountSegment, setAccountSegment] = useState("");
  const [noOfAccount, setNoOfAccount] = useState(1);
  const [response, setResponse] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null); // Added state for top-level errors
  const router = useRouter(); // Initialize the router

  useEffect(() => {
    // Check if we are in a browser environment first
    if (typeof window !== 'undefined') {
      const token = localStorage.getItem('access_token');
      if (!token) {
        console.log("No token found on load, redirecting to login.");
        setError('You are not authenticated. Redirecting to login...');
        router.push('/login');
      }
    }
  }, [router]);// Dependency array ensures this runs once when the component mounts

  // ----------------------------------------------------


  const handleSubmit = async (event) => {
    event.preventDefault();
    setLoading(true);
    setResponse([]);
    setError(null); // Clear previous errors

    // --- ADDED: Retrieve the token from local storage ---
    const token = localStorage.getItem('access_token');

    if (!token) {
      setError('No authentication token found. Please log in.');
      setLoading(false);
      // Redirect to login page if no token exists
      router.push('/login');
      return;
    }
    // ----------------------------------------------------

    // Conditionally set the base URL based on the accountType state
    let url;
    switch (accountType) {
      case 'CCOD':
        url = `http://10.1.161.164:5050/create_ccod/`;
        break;
      case 'KCC':
        url = `http://10.1.161.164:5050/create_kcc/`;
        break;
      case 'DL-TL':
        url = `http://10.1.161.164:5050/create_dltl/`;
        break;
      case 'DEPOSIT':
      default:
        url = `http://10.1.161.164:5050/create_deposit_account/`;
        break;
    }

    const payload = {
      region: region,
      cif: cifNumber,
      p_code: productCode,
      seg_code: accountSegment,
      no_acc: parseInt(noOfAccount, 10),
    };

    console.log(payload)
    try {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          // --- ADDED: Include the Authorization header ---
          'Authorization': `Bearer ${token}`,
          // ----------------------------------------------
        },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        if (res.status === 401 || res.status === 403) {
          // Handle unauthorized/forbidden errors specifically
          localStorage.removeItem('access_token'); // Clear invalid token
          setError('Session expired or unauthorized. Please log in again.');
          router.push('/login'); // Redirect to login
          return;
        }
        throw new Error(`API returned an error: ${res.status} ${res.statusText}`);
      }

      const data = await res.json();
      setResponse(data);
      if (data.length > 0) {
        console.log(data[0].RRN);
      }
      console.log(data)

    } catch (error) {
      console.error("Fetch error:", error);
      // If the error was a network error or generic fetch error, set the response error data
      if (!error.message.includes('unauthorized')) {
        setResponse([{ res_data: JSON.stringify({ ERROR_DESCRIPTION: error.message }) }]);
      }
    } finally {
      setLoading(false);
    }
  };

  const downloadCsv = () => {
    if (!response || response.length === 0) {
      alert("No data to download.");
      return;
    }

    const headers = ["Account Number", "RRN"];
    let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";

    response.forEach(item => {
      try {
        const parsedResData = JSON.parse(item.res_data);
        const row = [
          parsedResData.ACCOUNT_NUMBER || '',
          item.RRN || ''
        ].map(field => `"${field}"`).join(",");
        csvContent += row + "\n";
      } catch (e) {
        console.error("Error parsing res_data for CSV:", e);
      }
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `${accountType.toLowerCase()}_accounts.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const [ccodregion, setccodRegion] = useState("O");
  const [cif, setCif] = useState("");
  const [prod_code, setProd_code] = useState("");
  const [acc_segment, setAcc_Segment] = useState("");
  const [no_acc, setNo_acc] = useState(1);
  const [ccodresponse, setccodResponse] = useState([]);
  const [ccodloading, setccodLoading] = useState(false);
  const [ccoderror, setCcoderror] = useState([]);

  // Optional: You can render a loading/redirecting message while the effect runs
  if (!localStorage.getItem('access_token') && typeof window !== 'undefined') {
    return <p className={styles.loadingText}>{error || 'Checking authentication...'}</p>;
  }

 
