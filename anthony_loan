import { useState } from "react";
import { styles } from "../../styles/AppStyles";

export default function LoanAccountView() {
  const [region, setRegion] = useState("");
  const [loan_type, setLoan_type] = useState("");
  const [cif, setCif] = useState("");
  const [response, setResponse] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const handleSubmit = async (event) => {
    event.preventDefault();
    setLoading(true);
    setError(null);
    setResponse([]);
    
    const userToken = localStorage.getItem("userToken");
    const url = `http://10.1.161.164:5050/loan_account_creation/`;

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${userToken}`,
        },
        body: JSON.stringify({
          region: region,
          loan_type: loan_type,
          ...(cif && { cif: cif }),  // Include CIF only if provided
        }),
      });

      const data = await res.json();
      console.log("API Response Data:", data);
      console.log("Request sent:", { region, loantype: loan_type });

      if (!res.ok) {
        console.error("API Error Details:", data);
        throw new Error(
          `API returned an error: ${res.status} ${res.statusText} - ${JSON.stringify(data)}`
        );
      }

      setResponse(data);
    } catch (err) {
      console.error("Fetch error:", err);
      setError(err.message);
      setResponse([
        { res_data: JSON.stringify({ ERROR_DESCRIPTION: err.message }) },
      ]);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div>
      <div style={styles.pageHeader}>
        <div>
          <h1 style={styles.pageTitle}>Create Loan Account</h1>
          <p style={styles.pageSubtitle}>Generate loan accounts for testing</p>
        </div>
      </div>

      <div style={styles.formCard}>
        <form onSubmit={handleSubmit}>
          <div style={styles.formGrid}>
            <div style={styles.formGroup}>
              <label style={styles.label}>Region</label>
              <select
                value={region}
                onChange={(e) => setRegion(e.target.value)}
                style={styles.select}
                required
              >
                <option value="">Select Region</option>
                <option value="O">O - UAT</option>
                <option value="X">X - UAT</option>
                <option value="Y">Y - UAT</option>
                <option value="Z">Z - UAT</option>
                <option value="K">K - Pre-Prod</option>
                <option value="J">J - Pre-Prod</option>
                <option value="R1">R1 - Pre-Prod</option>
                <option value="Y2">Y2 - Pre-Prod</option>
                <option value="L">L - Pre-Prod</option>
                <option value="C">C - Pre-Prod</option>
              </select>
            </div>

            <div style={styles.formGroup}>
              <label style={styles.label}>CIF</label>
              <input
                type="text"
                value={cif}
                onChange={(e) => setCif(e.target.value)}
                style={styles.input}
                placeholder="Enter CIF (optional)"
              />
            </div>

            <div style={styles.formGroup}>
              <label style={styles.label}>Loan Type</label>
              <select
                value={loan_type}
                onChange={(e) => setLoan_type(e.target.value)}
                style={styles.select}
                required
              >
                <option value="">Select Loan Type</option>
                <option value="home">Home Loan</option>
                <option value="education">Education Loan</option>
                <option value="vehicle">Vehicle Loan</option>
                <option value="agri">Agriculture Loan</option>
              </select>
            </div>
          </div>

          <button 
            type="submit" 
            style={styles.primaryButton} 
            disabled={loading}
          >
            {loading ? "Submitting..." : "Submit"}
          </button>
        </form>
      </div>

      {/* Display Error */}
      {error && !response.length && (
        <div style={styles.resultsCard}>
          <div style={styles.errorMsg}>
            <strong>Error:</strong> {error}
          </div>
        </div>
      )}

      {/* Display Response Data */}
      {response && response.length > 0 && (
        <div style={styles.resultsCard}>
          <h2 style={styles.resultsTitle}>Loan Account Creation Results</h2>
          <div style={styles.resultsList}>
            {response.map((item, index) => {
              try {
                const parsedResData = JSON.parse(item.res_data);
                return (
                  <div key={index} style={styles.resultItem}>
                    <div style={styles.resultContent}>
                      <p><strong>MIN:</strong> {item.MIN}</p>
                      <p><strong>Customer Number:</strong> {parsedResData.CUSTOMER_NUMBER}</p>
                      <p><strong>Account Number:</strong> {parsedResData.ACCOUNT_NUMBER}</p>
                      {parsedResData.ERROR_DESCRIPTION && (
                        <p style={styles.errorText}>
                          <strong>Error:</strong> {parsedResData.ERROR_DESCRIPTION}
                        </p>
                      )}
                    </div>
                  </div>
                );
              } catch (e) {
                return (
                  <div key={index} style={styles.resultItem}>
                    <div style={styles.resultContent}>
                      <p style={styles.errorText}>
                        <strong>Error parsing response for item {index}:</strong> {item.res_data}
                      </p>
                    </div>
                  </div>
                );
              }
            })}
          </div>
        </div>
      )}
    </div>
  );
}
