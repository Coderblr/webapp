@app.post("/full_onboarding_with_excel/")
async def full_onboarding_with_excel(
    file: UploadFile = File(...)
):
    region: str = "Y2"
    
    try:
        # Read uploaded Excel file
        contents = await file.read()
        df = pd.read_excel(contents)
        data = df.to_json(orient='records')
        dic = json.loads(data)
        r_code = Configs.get_region(region)
        if r_code == "AAA":
                raise HTTPException(status_code=400, detail="Invalid region")
        RRN = "SBI" + r_code
        response = []
        for _ in range(2):
            RRNO_CIF = Configs.generate_random_string_with_timestamp(RRN)
            payload = CIF_Dep_Payload.generate_pcif_entry(RRNO_CIF, r_code)
            for key in dic[_].keys() & payload.keys():
                payload[key] = dic[_][key]
            print(payload)
            cif_response = EIS_API.get_pers_cif(
                json.dumps(payload),
                RRNO_CIF
            )
            response.append(cif_response)
            print(response)

        

        # Parse CIF response
        cif_data = json.loads(cif_response) if isinstance(cif_response, str) else cif_response
        
        # Handle nested response structure
        if 'res_data' in cif_data:
           
            cif_res_data = json.loads(cif_data['res_data'])
            cif_account_number = '85652456325'
            cif_account_number = cif_res_data.get("CUSTOMER_NUMBER", "")
        else:
            cif_account_number = cif_data.get("CUSTOMER_NUMBER", "")
        
        print(f"CIF Account Number: {cif_account_number}")
        
        return response




# Step 2: Create CKYC
        RRNO_CKYC = Configs.generate_random_string_with_timestamp(RRN)
        print(f"Step 2: Creating CKYC with RRN: {RRNO_CKYC}")
        
        ckyc_payload_dict = CKYC_EXCEL.generate_ckyc_entry(
            r_code,
            cif_account_number
        )
        ckyc_response = EIS_API.get_ckyc_eis(
            json.dumps(ckyc_payload_dict), 
            RRNO_CKYC
        )
        
        print(ckyc_payload_dict)     

# Step 2: Create DEPOSIT

        RRNO_DEPOSIT = Configs.generate_random_string_with_timestamp(RRN)
        print(f"Step 3: Creating Deposit Account with RRN: {RRNO_DEPOSIT}")
                
        deposit_payload_dict = DEPOSIT_EXCEL.deposit_account_excel(
            r_code,
            cif_account_number,
            p_code,
            seg_code
        )
        deposit_response = EIS_API.get_deposit_eis(
            json.dumps(deposit_payload_dict), 
            RRNO_DEPOSIT
        )

        
        deposit_data = json.loads(deposit_response) if isinstance(deposit_response, str) else deposit_response
        
        if 'res_data' in deposit_data:
            deposit_res_data = json.loads(deposit_data['res_data'])
            deposit_account_number = deposit_res_data.get("ACCOUNT_NUMBER", "")
        else:
            deposit_account_number = deposit_data.get("ACCOUNT_NUMBER", "")
        
        print(f"Deposit Account Number: {deposit_account_number}")
        

    except Exception as e:
        print(f"Error in fund transfer: {str(e)}")
        raise HTTPException(
            status_code=500,
            detail=f"Fund transfer failed: {str(e)}"
        )
