"use client";

import React, { useState, useEffect } from 'react';
import { CreditCard, Save, Loader2, Layers } from 'lucide-react';

export default function AccountCreationPage() {
    const MAX_ACCOUNTS = 10; // Maximum accounts allowed per request

    const [serviceType, setServiceType] = useState('Deposit');
    const [loading, setLoading] = useState(false);

    // Common State
    const [region, setRegion] = useState('O - UAT');
    const [cifNumber, setCifNumber] = useState('');

    // Specific State
    const [productCode, setProductCode] = useState('');
    const [accountSegment, setAccountSegment] = useState('');
    const [noOfAccounts, setNoOfAccounts] = useState(1);
    const [category, setCategory] = useState(''); // For CKYC
    const [relcat, setRelcat] = useState(''); // For Social Attribute

    // Reset form fields when service type changes
    useEffect(() => {
        setCifNumber('');
        setProductCode('');
        setAccountSegment('');
        setNoOfAccounts(1);
        setCategory('');
        setRelcat('');
    }, [serviceType]);

    const regions = [
        'O - UAT', 'X - UAT', 'Y - UAT', 'Z - UAT',
        'K - Pre-Prod', 'J - Pre-Prod', 'R1 - Pre-Prod',
        'Y2 - Pre-Prod', 'L - Pre-Prod', 'C - Pre-Prod'
    ];

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);

        try {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser || !currentUser.token) {
                throw new Error("You must be logged in to perform this action.");
            }

            let endpoint = '';
            let payload = {};

            // Construct payload based on Service Type
            if (['Deposit', 'Loan', 'CCOD', 'KCC', 'DL-TL'].includes(serviceType)) {
                endpoint = serviceType === 'Deposit' ? '/create_deposit_account/' :
                    serviceType === 'Loan' ? '/create_loan_account/' :
                        serviceType === 'CCOD' ? '/create_ccod/' :
                            serviceType === 'KCC' ? '/create_kcc/' :
                                '/create_dltl/';

                payload = {
                    cif: cifNumber,
                    p_code: productCode,
                    seg_code: accountSegment,
                    region: region.split(' ')[0], // Extract region code
                    no_acc: Math.min(parseInt(noOfAccounts), MAX_ACCOUNTS) // Enforce max limit
                };
            } else if (serviceType === 'CKYC') {
                endpoint = '/create_ckyc/';
                payload = {
                    cif: cifNumber,
                    category: category,
                    region: region.split(' ')[0]
                };
            } else if (serviceType === 'Social Attribute') {
                endpoint = '/social_attribute/';
                payload = {
                    cif: cifNumber,
                    relcat: relcat,
                    region: region.split(' ')[0]
                };
            }

            const response = await fetch(`http://10.1.161.165:5050${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentUser.token}`
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Failed to create ${serviceType}`);
            }

            const data = await response.json();

            // ===== RESPONSE PARSING SECTION =====
            // Backend returns objects with {res_data: string, RRN: string} structure
            // Parse the response to extract meaningful data
            let parsedResults = [];
            if (Array.isArray(data)) {
                parsedResults = data.map(item => {
                    try {
                        // Try to parse res_data if it exists
                        if (item.res_data) {
                            const parsedResData = JSON.parse(item.res_data);
                            return {
                                ...parsedResData,
                                RRN: item.RRN || 'N/A'
                            };
                        }
                        return item;
                    } catch (e) {
                        console.error('Error parsing res_data:', e);
                        // If parsing fails, return the raw item
                        return {
                            error: 'Parse Error',
                            raw_data: item,
                            RRN: item.RRN || 'N/A'
                        };
                    }
                });
            }
            // ===== END RESPONSE PARSING SECTION =====

            console.log('Success:', parsedResults);

            // Update Local Storage for Stats
            const userKey = `userData_${currentUser.username}`;
            const userData = JSON.parse(localStorage.getItem(userKey) || '{"cifs": [], "accounts": []}');

            // Add a record of this action
            userData.accounts.push({
                id: Date.now(),
                type: serviceType,
                cifNumber: cifNumber,
                details: payload,
                results: parsedResults,
                createdAt: new Date().toISOString(),
                status: 'Success'
            });

            localStorage.setItem(userKey, JSON.stringify(userData));

            alert(`${serviceType} Created Successfully!`);

        } catch (error) {
            console.error(`Error creating ${serviceType}:`, error);
            alert(error.message || `Failed to create ${serviceType}`);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div>
            <div style={{ marginBottom: '2rem' }}>
                <h1 style={{ fontSize: '1.875rem', fontWeight: '700', color: '#111827', display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                    <Layers size={32} color="var(--primary-color)" />
                    Service Creation
                </h1>
                <p style={{ color: '#6B7280', marginTop: '0.5rem' }}>Create Accounts, Loans, CKYC, and more.</p>
            </div>

            <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '1rem', boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)' }}>
                <form onSubmit={handleSubmit} style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>

                    {/* Service Type Selection */}
                    <div style={{ gridColumn: '1 / -1' }}>
                        <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', color: '#374151' }}>Select Service Type</label>
                        <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                            {['Deposit', 'Loan', 'CCOD', 'KCC', 'DL-TL', 'CKYC', 'Social Attribute'].map(type => (
                                <button
                                    key={type}
                                    type="button"
                                    onClick={() => setServiceType(type)}
                                    style={{
                                        padding: '0.75rem 1.5rem',
                                        borderRadius: '0.5rem',
                                        border: serviceType === type ? '2px solid var(--primary-color)' : '1px solid #D1D5DB',
                                        backgroundColor: serviceType === type ? '#EFF6FF' : 'white',
                                        color: serviceType === type ? 'var(--primary-color)' : '#374151',
                                        fontWeight: serviceType === type ? '600' : '400',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    {type}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div style={{ gridColumn: '1 / -1', height: '1px', backgroundColor: '#E5E7EB', margin: '1rem 0' }}></div>

                    {/* Common Fields */}
                    <div className="form-group">
                        <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '500', color: '#374151' }}>Region</label>
                        <select
                            required
                            style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #D1D5DB' }}
                            value={region}
                            onChange={(e) => setRegion(e.target.value)}
                        >
                            {regions.map(r => (
                                <option key={r} value={r}>{r}</option>
                            ))}
                        </select>
                    </div>

                    <div className="form-group">
                        <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '500', color: '#374151' }}>CIF Number</label>
                        <input
                            type="text"
                            required
                            placeholder="Enter CIF Number"
                            style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #D1D5DB' }}
                            value={cifNumber}
                            onChange={(e) => setCifNumber(e.target.value)}
                        />
                    </div>

                    {/* Conditional Fields */}
                    {['Deposit', 'Loan', 'CCOD', 'KCC', 'DL-TL'].includes(serviceType) && (
                        <>
                            <div className="form-group">
                                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '500', color: '#374151' }}>Product Code</label>
                                <input
                                    type="text"
                                    required
                                    placeholder="e.g., 10111101"
                                    style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #D1D5DB' }}
                                    value={productCode}
                                    onChange={(e) => setProductCode(e.target.value)}
                                />
                            </div>
                            <div className="form-group">
                                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '500', color: '#374151' }}>Account Segment</label>
                                <input
                                    type="text"
                                    required
                                    placeholder="e.g., 5025"
                                    style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #D1D5DB' }}
                                    value={accountSegment}
                                    onChange={(e) => setAccountSegment(e.target.value)}
                                />
                            </div>
                            <div className="form-group">
                                <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '500', color: '#374151' }}>No. of Accounts</label>
                                <input
                                    type="number"
                                    required
                                    min="1"
                                    max={MAX_ACCOUNTS}
                                    style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #D1D5DB' }}
                                    value={noOfAccounts}
                                    onChange={(e) => {
                                        const value = Math.min(e.target.value, MAX_ACCOUNTS);
                                        setNoOfAccounts(value);
                                    }}
                                />
                                <p style={{ marginTop: '0.5rem', fontSize: '0.875rem', color: '#6B7280' }}>
                                    Maximum {MAX_ACCOUNTS} accounts per request. You are creating {noOfAccounts} account(s).
                                </p>
                            </div>
                        </>
                    )}

                    {serviceType === 'CKYC' && (
                        <div className="form-group">
                            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '500', color: '#374151' }}>Category</label>
                            <input
                                type="text"
                                required
                                placeholder="Enter Category"
                                style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #D1D5DB' }}
                                value={category}
                                onChange={(e) => setCategory(e.target.value)}
                            />
                        </div>
                    )}

                    {serviceType === 'Social Attribute' && (
                        <div className="form-group">
                            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '500', color: '#374151' }}>Relcat</label>
                            <select
                                required
                                style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #D1D5DB' }}
                                value={relcat}
                                onChange={(e) => setRelcat(e.target.value)}
                            >
                                <option value="">Select a category</option>
                                <option value="010101 HINDU GENERAL">010101 HINDU GENERAL</option>
                                <option value="010102 HINDU SCHEDULED CASTE">010102 HINDU SCHEDULED CASTE</option>
                                <option value="010103 HINDU SCHEDULED TRIBE">010103 HINDU SCHEDULED TRIBE</option>
                                <option value="010104 HINDU OTHER BACKWARD CASTE">010104 HINDU OTHER BACKWARD CASTE</option>
                                <option value="010201 ISLAM GEN">010201 ISLAM GEN</option>
                                <option value="010301 CHRISTIAN GEN">010301 CHRISTIAN GEN</option>
                                <option value="010401 SIKH GEN">010401 SIKH GEN</option>
                                <option value="010402 SIKH SC">010402 SIKH SC</option>
                                <option value="010403 SIKH ST">010403 SIKH ST</option>
                                <option value="010404 SIKH OBC">010404 SIKH OBC</option>
                                <option value="010501 JAINS GEN">010501 JAINS GEN</option>
                                <option value="010601 BUDHIST GEN">010601 BUDHIST GEN</option>
                                <option value="010602 BUDHIST SC">010602 BUDHIST SC</option>
                                <option value="010603 BUDHIST ST">010603 BUDHIST ST</option>
                                <option value="010604 BUDHIST OBC">010604 BUDHIST OBC</option>
                                <option value="010701 ZORASTRIAN GEN">010701 ZORASTRIAN GEN</option>
                                <option value="010801 BAHAIST GEN">010801 BAHAIST GEN</option>
                                <option value="010901 JUDAIST GEN">010901 JUDAIST GEN</option>
                                <option value="011001 AGNOSTICIST GEN">011001 AGNOSTICIST GEN</option>
                            </select>
                        </div>
                    )}

                    <div style={{ gridColumn: '1 / -1', marginTop: '2rem', display: 'flex', justifyContent: 'flex-end' }}>
                        <button
                            type="submit"
                            disabled={loading}
                            className="btn btn-primary"
                            style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', opacity: loading ? 0.7 : 1 }}
                        >
                            {loading ? <Loader2 size={20} className="animate-spin" /> : <Save size={20} />}
                            {loading ? 'Processing...' : `Create ${serviceType}`}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}
