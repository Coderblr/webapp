import { useState } from "react";
import { styles } from "../../styles/AppStyles";

export default function LoanAccountView() {
  const [region, setRegion] = useState("");
  const [loan_type, setLoan_type] = useState("");
  const [cif, setCif] = useState("");
  const [response, setResponse] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const handleSubmit = async (event) => {
    event.preventDefault();
    setLoading(true);
    setError(null);
    setResponse(null);
    
    const userToken = localStorage.getItem("userToken");
    const url = `http://10.1.161.164:5050/loan_account_creation/`;

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${userToken}`,
        },
        body: JSON.stringify({
          region: region,
          loan_type: loan_type,
          ...(cif && { cif: cif }),  // Include CIF only if provided
        }),
      });

      if (!res.ok) {
        const errorData = await res.json();
        console.error("API Error Details:", errorData);
        throw new Error(
          `API returned an error: ${res.status} ${res.statusText} - ${JSON.stringify(errorData)}`
        );
      }

      const data = await res.json();
      console.log("API Response Data:", data);
      console.log("Request sent:", { region, loan_type });
      
      // Set the full response object
      setResponse(data);
    } catch (err) {
      console.error("Fetch error:", err);
      setError(err.message);
      setResponse(null);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div>
      <div style={styles.pageHeader}>
        <div>
          <h1 style={styles.pageTitle}>Create Loan Account</h1>
          <p style={styles.pageSubtitle}>Generate loan accounts for testing</p>
        </div>
      </div>

      <div style={styles.formCard}>
        <form onSubmit={handleSubmit}>
          <div style={styles.formGrid}>
            <div style={styles.formGroup}>
              <label style={styles.label}>Region</label>
              <select
                value={region}
                onChange={(e) => setRegion(e.target.value)}
                style={styles.select}
                required
              >
                <option value="">Select Region</option>
                <option value="O">O - UAT</option>
                <option value="X">X - UAT</option>
                <option value="Y">Y - UAT</option>
                <option value="Z">Z - UAT</option>
                <option value="K">K - Pre-Prod</option>
                <option value="J">J - Pre-Prod</option>
                <option value="R1">R1 - Pre-Prod</option>
                <option value="Y2">Y2 - Pre-Prod</option>
                <option value="L">L - Pre-Prod</option>
                <option value="C">C - Pre-Prod</option>
              </select>
            </div>

            <div style={styles.formGroup}>
              <label style={styles.label}>CIF</label>
              <input
                type="text"
                value={cif}
                onChange={(e) => setCif(e.target.value)}
                style={styles.input}
                placeholder="Enter CIF (optional)"
              />
            </div>

            <div style={styles.formGroup}>
              <label style={styles.label}>Loan Type</label>
              <select
                value={loan_type}
                onChange={(e) => setLoan_type(e.target.value)}
                style={styles.select}
                required
              >
                <option value="">Select Loan Type</option>
                <option value="home">Home Loan</option>
                <option value="education">Education Loan</option>
                <option value="vehicle">Vehicle Loan</option>
                <option value="agri">Agriculture Loan</option>
              </select>
            </div>
          </div>

          <button 
            type="submit" 
            style={styles.primaryButton} 
            disabled={loading}
          >
            {loading ? "Submitting..." : "Submit"}
          </button>
        </form>
      </div>

      {/* Display Error */}
      {error && !response && (
        <div style={styles.resultsCard}>
          <div style={styles.errorMsg}>
            <strong>Error:</strong> {error}
          </div>
        </div>
      )}

      {/* Display Response Data */}
      {response && response.loan_response && response.loan_response.length > 0 && (
        <div style={styles.resultsCard}>
          {/* Status Header */}
          <div style={{...styles.resultItem, backgroundColor: response.status === 'SUCCESS' ? '#d4edda' : '#f8d7da', borderLeft: response.status === 'SUCCESS' ? '4px solid #28a745' : '4px solid #dc3545'}}>
            <h2 style={styles.resultsTitle}>
              Status: {response.status}
              {response.toggle_response && ` | Toggle Response: ${response.toggle_response}`}
            </h2>
          </div>

          <h3 style={{...styles.resultsTitle, marginTop: '20px', fontSize: '18px'}}>
            Loan Account Details ({response.loan_response.length} account{response.loan_response.length > 1 ? 's' : ''})
          </h3>
          
          <div style={styles.resultsList}>
            {response.loan_response.map((item, index) => {
              // Parse the loan_response string if it's a string
              let accountData;
              try {
                accountData = typeof item === 'string' ? JSON.parse(item) : item;
              } catch (e) {
                accountData = item;
              }

              return (
                <div key={index} style={styles.resultItem}>
                  <div style={styles.resultContent}>
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '10px'}}>
                      <span style={{fontSize: '16px', fontWeight: '600', color: '#007bff'}}>
                        Account #{index + 1}
                      </span>
                    </div>
                    
                    {accountData.ACCOUNT_NUMBER && (
                      <p>
                        <strong>Account Number:</strong>{' '}
                        <span style={{color: '#28a745', fontSize: '16px', fontWeight: '600'}}>
                          {accountData.ACCOUNT_NUMBER}
                        </span>
                      </p>
                    )}
                    
                    {accountData.CUSTOMER_NUMBER && (
                      <p><strong>Customer Number:</strong> {accountData.CUSTOMER_NUMBER}</p>
                    )}
                    
                    {accountData.MIN && (
                      <p><strong>MIN:</strong> {accountData.MIN}</p>
                    )}
                    
                    {accountData.CIF && (
                      <p><strong>CIF:</strong> {accountData.CIF}</p>
                    )}
                    
                    {accountData.LOAN_TYPE && (
                      <p><strong>Loan Type:</strong> {accountData.LOAN_TYPE}</p>
                    )}
                    
                    {accountData.REGION && (
                      <p><strong>Region:</strong> {accountData.REGION}</p>
                    )}
                    
                    {accountData.ERROR_DESCRIPTION && (
                      <p style={styles.errorText}>
                        <strong>Error:</strong> {accountData.ERROR_DESCRIPTION}
                      </p>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
}
